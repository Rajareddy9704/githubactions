name: Clean Stale Branches

on:
  schedule:
    - cron: "*/5 * * * *"  # Runs every 5 minutes
  workflow_dispatch:      # Allows manual triggering of the workflow

jobs:
  clean-branches:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set Up Git
        run: |
          git config user.name "workflow-bot"
          git config user.email "workflow-bot@yourcompany.com"
          
      - name: Fetch All Branches
        run: git fetch --all

      - name: Identify Stale Branches
        id: identify_stale
        run: |
          CURRENT_TIME=$(date +%s)
          FIVE_MINUTES_AGO=$(($CURRENT_TIME - 300))
          git for-each-ref --sort=-committerdate refs/heads/ \
            --format='%(committerdate:unix) %(refname:short)' | while read -r timestamp branch; do
              # Skip protected branches (main, develop, testing)
              if [[ "$branch" == "main" || "$branch" == "develop" || "$branch" == "testing" ]]; then
                continue
              fi
              # Skip branches with user-specific prefixes (alice/, bob/, etc.)
              if [[ "$branch" =~ ^(alice|bob|charlie)/ ]]; then
                continue
              fi
              if [ $timestamp -lt $FIVE_MINUTES_AGO ]; then
                echo "Branch to delete: $branch"
                echo $branch >> stale_branches.txt
              fi
          done
        shell: bash

      - name: Delete Stale Branches
        if: steps.identify_stale.outputs.stale_branches != ''
        run: |
          while read -r branch; do
            echo "Deleting branch: $branch"
            git push origin --delete "$branch"
          done < stale_branches.txt
        shell: bash

